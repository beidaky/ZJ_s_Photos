<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Muse Gallery | Sakura Dream</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #fff9fa;
      --text-color: #4a4a4a;
      --accent-soft: #fce4ec;
      --accent-main: #f06292;
      --card-bg: #ffffff;
    }
    [data-theme='dark'] {
      --bg-color: #120f10;
      --text-color: #fce4ec;
      --accent-soft: #2a1b1f;
      --accent-main: #ff80ab;
      --card-bg: #1a1617;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      transition: background-color 0.5s ease, color 0.5s ease;
      font-family: 'Cormorant Garamond', Georgia, serif;
    }
    ::-webkit-scrollbar { display: none; }
    body { -ms-overflow-style: none; scrollbar-width: none; }

    #bg-canvas {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1; pointer-events: none;
    }
    .glass-btn {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(240,98,146,0.2);
    }
    [data-theme='dark'] .glass-btn {
      background: rgba(0,0,0,0.2);
    }
    @keyframes floating {
      0%,100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .animate-float { animation: floating 3s ease-in-out infinite; }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin { animation: spin 1s linear infinite; }

    @keyframes pulse {
      0%,100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }

    @keyframes bounce {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    .animate-bounce { animation: bounce 1s ease-in-out infinite; }

    /* Card styles */
    .photo-card {
      position: relative;
      cursor: pointer;
      overflow: hidden;
      border-radius: 2.5rem;
      background: var(--card-bg);
      transition: all 1s cubic-bezier(0.19,1,0.22,1);
      border: 2px solid transparent;
    }
    .photo-card:hover {
      box-shadow: 0 40px 80px -15px rgba(240,98,146,0.2);
      border-color: rgba(252,228,236,0.3);
    }
    .photo-card:active { transform: scale(0.98); }

    .photo-card .overlay {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      opacity: 0;
      transition: opacity 0.7s;
      background: rgba(0,0,0,0.05);
      pointer-events: none;
    }
    .photo-card:hover .overlay { opacity: 1; }

    .overlay-star {
      color: white;
      font-size: 1.875rem;
      font-weight: 300;
      transform: scale(0);
      transition: transform 0.7s 0.1s;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
    }
    .photo-card:hover .overlay-star { transform: scale(1); }

    .photo-card img {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 1s ease, transform 1s ease;
    }
    .photo-card:hover img { transform: scale(1.1); }
    .photo-card img.loaded { opacity: 1; }

    .skeleton {
      position: absolute; inset: 0;
      background: linear-gradient(135deg, var(--accent-soft), var(--bg-color));
    }

    /* Lightbox */
    #lightbox {
      position: fixed; inset: 0; z-index: 100;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none;
      transition: opacity 0.7s cubic-bezier(0.19,1,0.22,1);
    }
    #lightbox.open { opacity: 1; pointer-events: auto; }

    #lightbox-backdrop {
      position: absolute; inset: 0;
      background: rgba(0,0,0,0.0);
      backdrop-filter: blur(24px);
    }
    [data-theme='light'] #lightbox-backdrop {
      background: rgba(255,249,250,0.8);
    }
    [data-theme='dark'] #lightbox-backdrop {
      background: rgba(18,15,16,0.8);
    }

    #lightbox-content {
      position: relative;
      max-width: 85vw; max-height: 85vh;
      transform: scale(0.95) translateY(10px);
      opacity: 0;
      transition: all 1s cubic-bezier(0.19,1,0.22,1);
    }
    #lightbox.open #lightbox-content {
      transform: scale(1) translateY(0);
      opacity: 1;
    }
    #lightbox-img {
      max-width: 100%; max-height: 85vh;
      object-fit: contain;
      border-radius: 2.5rem;
      box-shadow: 0 50px 100px rgba(0,0,0,0.3);
      border: 4px solid var(--card-bg);
    }
    #lightbox-caption {
      position: absolute; bottom: -4rem; left: 0; width: 100%;
      text-align: center;
      color: rgba(240,98,146,0.4);
      font-size: 10px; font-weight: 500;
      letter-spacing: 0.5em; text-transform: uppercase;
    }

    /* Loading */
    #loading {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      min-height: 100vh;
      color: rgba(240,98,146,0.6);
      font-weight: 500;
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }
    #app { display: none; }

    /* Controls */
    #controls {
      position: fixed; bottom: 2rem; right: 2rem;
      z-index: 40;
      display: flex; flex-direction: column; gap: 1rem;
    }
    .ctrl-btn {
      padding: 1.25rem;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.7s;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      border: none;
      outline: none;
    }
    .ctrl-btn:hover { transform: scale(1.1); }
    .ctrl-btn:active { transform: scale(0.95); }
    .ctrl-btn.active {
      transform: scale(1.1);
      border-color: rgba(240,98,146,0.6) !important;
      background: rgba(240,98,146,0.05) !important;
    }

    #lightbox-close {
      position: absolute; top: 2rem; right: 2rem;
      color: rgba(240,98,146,0.5);
      cursor: pointer;
      transition: all 0.5s;
      z-index: 10; background: none; border: none; padding: 0.5rem;
    }
    #lightbox-close:hover {
      color: #f06292;
      transform: rotate(90deg);
    }

    /* Masonry grid */
    .masonry-desktop {
      display: none;
      gap: 2.5rem;
      width: 100%;
      max-width: 1500px;
    }
    .masonry-mobile {
      display: flex;
      gap: 1.25rem;
      width: 100%;
    }
    @media (min-width: 768px) {
      .masonry-desktop { display: flex; }
      .masonry-mobile { display: none; }
    }
    .masonry-col {
      display: flex; flex-direction: column;
      flex: 1; gap: 2.5rem;
    }
    .masonry-col-mobile {
      display: flex; flex-direction: column;
      flex: 1; gap: 1.25rem;
    }

    .divider {
      width: 4rem; height: 1px;
      background: linear-gradient(to right, transparent, rgba(240,98,146,0.4), transparent);
      margin: 1rem auto 0;
    }

    /* End loader dot */
    #end-loader {
      height: 40vh; width: 100%;
      display: flex; align-items: center; justify-content: center;
    }
  </style>
</head>
<body>
  <canvas id="bg-canvas"></canvas>

  <!-- Loading screen -->
  <div id="loading">
    <div style="position:relative;margin-bottom:1.5rem;">
      <div style="width:3rem;height:3rem;border:4px solid rgba(240,98,146,0.1);border-top-color:#f06292;border-radius:50%;" class="animate-spin"></div>
    </div>
    Curating Dreamscape
  </div>

  <!-- Main app -->
  <div id="app">
    <main style="max-width:none;padding:3rem 1rem 5rem;">
      <header class="animate-float" style="margin-bottom:4rem;text-align:center;position:relative;">
        <h1 style="font-size:clamp(1.8rem,5vw,3.5rem);font-style:italic;color:rgba(240,98,146,0.8);letter-spacing:0.25em;font-weight:300;margin:0;">
          ZJ's Photos | 相册
        </h1>
        <div class="divider"></div>
      </header>

      <div style="display:flex;justify-content:center;">
        <!-- Desktop 4 cols -->
        <div class="masonry-desktop" id="grid-desktop"></div>
        <!-- Mobile 2 cols -->
        <div class="masonry-mobile" id="grid-mobile"></div>
      </div>

      <div id="end-loader">
        <div style="display:flex;flex-direction:column;align-items:center;gap:1rem;opacity:0.3;">
          <div style="width:0.375rem;height:0.375rem;background:#f06292;border-radius:50%;" class="animate-bounce"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button id="btn-theme" class="ctrl-btn glass-btn" title="Toggle Theme">
      <svg xmlns="http://www.w3.org/2000/svg" style="width:1.5rem;height:1.5rem;color:#f06292;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
      </svg>
    </button>
    <button id="btn-scroll" class="ctrl-btn glass-btn" title="Auto Scroll">
      <svg id="icon-scroll-off" xmlns="http://www.w3.org/2000/svg" style="width:1.5rem;height:1.5rem;color:rgba(240,98,146,0.6);" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 13l-7 7-7-7m14-8l-7 7-7-7"/>
      </svg>
      <svg id="icon-scroll-on" xmlns="http://www.w3.org/2000/svg" style="width:1.5rem;height:1.5rem;color:#f06292;display:none;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 9v6m4-6v6"/>
      </svg>
    </button>
  </div>

  <!-- Lightbox -->
  <div id="lightbox">
    <div id="lightbox-backdrop"></div>
    <button id="lightbox-close">
      <svg xmlns="http://www.w3.org/2000/svg" style="width:2.5rem;height:2.5rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    <div id="lightbox-content">
      <img id="lightbox-img" src="" alt="">
      <div id="lightbox-caption"></div>
    </div>
  </div>

<script>
(function(){
  // ── 自动检测 images/ 文件夹里的照片（p1.jpg ~ p20.jpg）─────────────
  // 使用说明：把照片命名为 p1.jpg, p2.jpg ... p20.jpg，上传到仓库的 images/ 文件夹
  // 代码会自动检测哪些存在，自动读取真实宽高，无需手动修改任何代码

  const MAX_PHOTOS = 20; // 最多支持20张，可以改大

  function getImageSize(url) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload  = () => resolve({ width: img.naturalWidth, height: img.naturalHeight, exists: true });
      img.onerror = () => resolve({ exists: false });
      img.src = url;
    });
  }

  async function loadPhotoData() {
    const checks = [];
    for (let i = 1; i <= MAX_PHOTOS; i++) {
      const url = `./images/p${i}.jpg`;
      checks.push(getImageSize(url).then(result => ({ i, url, ...result })));
    }
    const results = await Promise.all(checks);
    return results
      .filter(r => r.exists)
      .map(r => ({
        id:       String(r.i),
        filename: `p${r.i}.jpg`,
        width:    r.width,
        height:   r.height,
        url:      r.url
      }));
  }

  let photos = [];
  let theme = 'light';
  let isAutoScrolling = false;
  let scrollAnimId = null;

  // ── Sparkle canvas ─────────────────────────────────────────────────
  const canvas = document.getElementById('bg-canvas');
  const ctx = canvas.getContext('2d');
  let particles = [];
  let cw = canvas.width = window.innerWidth;
  let ch = canvas.height = window.innerHeight;

  window.addEventListener('resize', () => {
    cw = canvas.width = window.innerWidth;
    ch = canvas.height = window.innerHeight;
  });

  function createParticle(x, y) {
    const size = Math.random() * 4 + 1;
    const h = 340 + Math.random() * 20;
    const colorBase = theme === 'light'
      ? `hsla(${h}, 100%, 80%,`
      : `hsla(${h}, 80%, 60%,`;
    return { x, y, vx:(Math.random()-0.5)*2, vy:(Math.random()-0.5)*2, life:1, color:colorBase, size };
  }

  window.addEventListener('mousemove', e => {
    for(let i=0;i<3;i++) particles.push(createParticle(e.clientX, e.clientY));
  });

  (function animate(){
    ctx.clearRect(0,0,cw,ch);
    for(let i=0;i<particles.length;i++){
      const p=particles[i];
      p.x+=p.vx; p.y+=p.vy; p.life-=0.008;
      ctx.fillStyle=p.color+p.life+')';
      ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
      if(p.life<=0){ particles.splice(i,1); i--; }
    }
    requestAnimationFrame(animate);
  })();

  // ── Theme toggle ───────────────────────────────────────────────────
  const htmlEl = document.documentElement;
  const btnTheme = document.getElementById('btn-theme');
  btnTheme.addEventListener('click', () => {
    theme = theme==='light'?'dark':'light';
    htmlEl.setAttribute('data-theme', theme);
    btnTheme.innerHTML = theme==='light'
      ? `<svg xmlns="http://www.w3.org/2000/svg" style="width:1.5rem;height:1.5rem;color:#f06292;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>`
      : `<svg xmlns="http://www.w3.org/2000/svg" style="width:1.5rem;height:1.5rem;color:#f06292;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>`;
  });

  // ── Auto-scroll ────────────────────────────────────────────────────
  const btnScroll = document.getElementById('btn-scroll');
  const iconOff = document.getElementById('icon-scroll-off');
  const iconOn  = document.getElementById('icon-scroll-on');

  btnScroll.addEventListener('click', () => {
    isAutoScrolling = !isAutoScrolling;
    btnScroll.classList.toggle('active', isAutoScrolling);
    iconOff.style.display = isAutoScrolling ? 'none' : '';
    iconOn.style.display  = isAutoScrolling ? '' : 'none';
    if(isAutoScrolling){
      (function scroll(){
        window.scrollBy({top:1.5,behavior:'auto'});
        scrollAnimId = requestAnimationFrame(scroll);
      })();
    } else {
      if(scrollAnimId) cancelAnimationFrame(scrollAnimId);
    }
  });

  // ── Masonry distribution ───────────────────────────────────────────
  function distributePhotos(items, cols) {
    const colArrays = Array.from({length:cols},()=>[]);
    const colHeights = new Array(cols).fill(0);
    items.forEach(photo => {
      let shortest=0;
      for(let i=1;i<cols;i++) if(colHeights[i]<colHeights[shortest]) shortest=i;
      colArrays[shortest].push(photo);
      colHeights[shortest]+=(photo.height/photo.width);
    });
    return colArrays;
  }

  // ── Create photo card ──────────────────────────────────────────────
  function createCard(photo) {
    const aspectRatio = (photo.height / photo.width) * 100;
    const card = document.createElement('div');
    card.className = 'photo-card';

    const inner = document.createElement('div');
    inner.style.cssText = `padding-bottom:${aspectRatio}%;position:relative;width:100%;`;

    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton animate-pulse';

    const img = document.createElement('img');
    img.src = photo.url;
    img.alt = photo.filename;
    img.loading = 'lazy';
    img.addEventListener('load', () => img.classList.add('loaded'));

    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    const star = document.createElement('span');
    star.className = 'overlay-star';
    star.textContent = '✧';
    overlay.appendChild(star);

    inner.appendChild(skeleton);
    inner.appendChild(img);
    card.appendChild(inner);
    card.appendChild(overlay);

    card.addEventListener('click', () => openLightbox(photo));
    return card;
  }

  // ── Build / update grid ────────────────────────────────────────────
  function buildGrid(items) {
    const desktopGrid = document.getElementById('grid-desktop');
    const mobileGrid  = document.getElementById('grid-mobile');

    const desktopCols = distributePhotos(items, 4);
    const mobileCols  = distributePhotos(items, 2);

    // Desktop
    desktopGrid.innerHTML = '';
    desktopCols.forEach(col => {
      const colEl = document.createElement('div');
      colEl.className = 'masonry-col';
      col.forEach(p => colEl.appendChild(createCard(p)));
      desktopGrid.appendChild(colEl);
    });

    // Mobile
    mobileGrid.innerHTML = '';
    mobileCols.forEach(col => {
      const colEl = document.createElement('div');
      colEl.className = 'masonry-col-mobile';
      col.forEach(p => colEl.appendChild(createCard(p)));
      mobileGrid.appendChild(colEl);
    });
  }

  // ── Lightbox ───────────────────────────────────────────────────────
  const lightbox     = document.getElementById('lightbox');
  const lightboxImg  = document.getElementById('lightbox-img');
  const lightboxCap  = document.getElementById('lightbox-caption');
  const lightboxClose= document.getElementById('lightbox-close');
  const lightboxBack = document.getElementById('lightbox-backdrop');

  function openLightbox(photo) {
    lightboxImg.src = photo.url;
    lightboxImg.alt = photo.filename;
    lightboxCap.textContent = `Captured Muse · Edition ${photo.id.slice(0,4)}`;
    document.body.style.overflow = 'hidden';
    lightbox.classList.add('open');
  }

  function closeLightbox() {
    lightbox.classList.remove('open');
    document.body.style.overflow = '';
  }

  lightboxClose.addEventListener('click', closeLightbox);
  lightboxBack.addEventListener('click', closeLightbox);
  window.addEventListener('keydown', e => { if(e.key==='Escape') closeLightbox(); });

  // ── Infinite scroll / load more ────────────────────────────────────
  let displayPhotos = [];
  let batchCount = 0;

  // observer 在 init() 里初始化（需要等照片数据加载完）
  const observer = new IntersectionObserver(() => {}, {});
  observer.observe(document.getElementById('end-loader'));

  // ── Init ───────────────────────────────────────────────────────────
  async function init() {
    let PHOTO_DATA = await loadPhotoData();

    // 如果 images/ 文件夹里一张都没有（比如本地预览），就用示例图顶替
    if (PHOTO_DATA.length === 0) {
      const fallback = [
        { id:"1", width:800,  height:1200 },
        { id:"2", width:1200, height:800  },
        { id:"3", width:800,  height:1000 },
        { id:"4", width:1000, height:800  },
        { id:"5", width:800,  height:800  },
        { id:"6", width:900,  height:1300 },
        { id:"7", width:1400, height:900  },
        { id:"8", width:800,  height:1100 }
      ];
      PHOTO_DATA = fallback.map(p => ({
        ...p,
        filename: `photo${p.id}.jpg`,
        url: `https://picsum.photos/seed/${p.id}/${p.width}/${p.height}`
      }));
    }

    // 重新绑定 loadMore 使用真实数据
    function loadMore() {
      const nextBatch = [];
      for(let i=0;i<3;i++){
        PHOTO_DATA.forEach(p => nextBatch.push({
          ...p, id:`batch-${batchCount}-${i}-${p.id}`
        }));
      }
      batchCount++;
      displayPhotos = displayPhotos.concat(nextBatch);
      buildGrid(displayPhotos);
    }

    observer.disconnect();
    const newObserver = new IntersectionObserver(entries => {
      if(entries[0].isIntersecting) loadMore();
    }, { rootMargin:'3000px', threshold:0.01 });
    newObserver.observe(document.getElementById('end-loader'));

    // 初始批次
    const initialBuffer = [];
    for(let i=0;i<6;i++){
      PHOTO_DATA.forEach(p => initialBuffer.push({
        ...p, id:`init-${i}-${p.id}`
      }));
    }
    displayPhotos = initialBuffer;
    buildGrid(displayPhotos);

    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'block';
  }

  init();

})();
</script>
</body>
</html>
